---
title: "PSP data cleaning"
author: "A. Clason"
date: "September 16, 2019"
output: html_document
---
Libraries
```{r}
library(data.table)
```

Import data
```{r}
r.path <- "L:/PSP data/PSP csv/"

#Import sample and then tree data
dat.type <- c("Sample","Trees")
tsas <- c("03","12","14","20","24","26")
read.list <- list()
dat.list <- list()

for(i in 1:length(dat.type)){
  setwd(paste0(r.path,dat.type[i]))
  for(j in 1:length(tsas)){
      read.list[[j]]<- fread(paste0("TSA",tsas[j],".csv"))
  }
  dat.list[[i]] <- rbindlist(read.list)
}
#result is dat.list which contains [[1]]:Sample and [[2]]Trees 
```

SITE SERIES APPROACH:

Sample data

This step will involve understanding all the information on a plot that is available, and determining which plots will be useful for a given purpose. Once the plots are id'd then can select those plotIDs from the Trees dataset (element 2 in dat.list)
Minimum Criteria:
1. Is the plot in the SBSmc2?
2. Does it have a Site Series call?

```{r}
#take the sample data.table out of a list and save in data.table format
samples.dt <- (dat.list[[1]])
# Remove repeats (which I think represent sub-plots)
uni.samples.dt<-unique(samples.dt, by="SAMP_ID")

#create the list of criteria needed to determine whether a plot should be included. This assumes that coding is consistent i.e SBSmc2 is spelled the same across datasets.
criteria.samples <- uni.samples.dt[beclabel=="SBSmc2" & bgc_ss_grd>0]
table(criteria.samples$bgc_ss_grd)
```

Re-measurement criteria:

1. What plots have multiple measurements?
2. What is the greatest time span for these measurements?
```{r}
remeas.samples <- criteria.samples[(criteria.samples[,meas_yr_first]!=criteria.samples[,meas_yr_last])]
range(remeas.samples[,tot_period]) #indicates min. remeasurement is 10 years
table(remeas.samples$bgc_ss_grd)
```
There could be one analysis here that tries to grow specific plot situations: thinned, beetle-killed etc. But for now, proceed to find the most number of plots that conform

Analysis criteria:

1. Remove if thinned
2. Remove if the plot planted (only 2 and they were also thinned)
```{r}
analysis.samples <- remeas.samples[treatment != "THINNED" & stnd_org!="P"] #72? plots if use site series calls

#it seems that there is only 1 plot for all plots I've cut down to if I use all plots and don't remove duplicates:
all.samps.dt <- samples.dt[beclabel=="SBSmc2" & bgc_ss_grd>0 & meas_yr_first != meas_yr_last & treatment != "THINNED"] 
all.samps.dt[,area_pm == area_ps]
range(all.samps.dt[, no_plots])
unique(all.samps.dt[, shp_pm]) #all circles
all.samps.dt[SAMP_ID=="CMI5_0232_NFI",area_pm] #just saw different calls on Site Series for this plot - 01 in 2001, 02 in 2017

all.samps.dt[which(all.samps.dt[,bgc_ss_grd==2]),.(SAMP_ID,tsa)]

analysis.samples[,no_plots]
analysis.samples[,area_ps]

samples.dt[SAMP_ID=="CMI5_0232_NFI",1:100]

analysis.samples[,area_pm]
remeas.samples[,no_plots]
remeas.samples[,no_meas]

remeas.samples[,dbhlimit_breakpt] #tag limit in main vs. subplots
remeas.samples[,dbhlimit_tag] #tag limit in sub-plots
remeas.samples[which(remeas.samples[,bgc_ss_grd==2]),SAMP_ID]
```


SITE INDEX APPROACH:

Doing the same steps, but figuring out how many more or different plots meet the criteria if we include SI
```{r}
#looking at site index range from the plots that meet my criteria other then having site series:
samples.dt <- (dat.list[[1]])
uni.samples.dt<-unique(samples.dt, by="SAMP_ID")
criteria.samples <- uni.samples.dt[beclabel=="SBSmc2"]
remeas.samples <- criteria.samples[(criteria.samples[,meas_yr_first]!=criteria.samples[,meas_yr_last])]
range(remeas.samples[,tot_period]) #indicates min. remeasurement is 5 years
remeas.samples <- remeas.samples[tot_period>=10] #now has to be 10 years minimum
analysis.samples <- remeas.samples[treatment != "THINNED" & stnd_org!="P" & spc_live1!=""]
analysis.samples[,spc_live1] #104 potential plots if use SI

#look at possible 02 sites:
pine.lead <- analysis.samples[spc_live1=="PL"] #65 stands pine leading
pine.lead[,.(lead_si1,lead_si3,lead_si4,bh_stand_age)]
pine.lead[,lead_si1 := ifelse(lead_si1==-99,NA,lead_si1)]
pine.lead[,bgc_ss_grd := ifelse(is.na(bgc_ss_grd),11,bgc_ss_grd)]
pine.lead[,.(SAMP_ID,tsa,bgc_ss_grd,lead_si1,lead_si3,lead_si4,bh_stand_age)]#[order(lead_si1)]

# So lead_si4 comes from a TEM/PEM/SIBEC map layer. It's tempting to maintain this as an option on the hierarchy of data quality. Seems like it's too coarse to pick out the least productive sites (02?)

hist(pine.lead[,lead_si1a])
hist(pine.lead[,lead_si3a])
hist(pine.lead[,lead_si4a])

#what if I look at all plots and not just pine leading?
analysis.samples[,.(SAMP_ID,tsa,bgc_ss_grd,spc_live1,lead_si1,lead_si3,lead_si4,lead_age_bh1)][order(lead_si1)]

#what if I used an ordination to classify plots based on leading species, SI, Age, Density, etc.
#So far, I can't see any grouping using ordinations, but could use a classification tree (random forest approach)
library(vegan)
library(ecodist)
pca.pine.lead <- princomp(na.omit(pine.lead[,.(lead_si1,lead_si3,lead_si4,bh_stand_age,stemsha_LIV)]))
biplot(pca.pine.lead)

dist.pine.lead <- bcdist(na.omit(pine.lead[,.(lead_si1,lead_si3,lead_si4,bh_stand_age,stemsha_LIV,aspect, slope)]))
nmds_out <- nmds(dist.pine.lead, mindim=2, maxdim=2)
scores <- nmds.min(nmds_out)
sort(pine.lead[,bgc_ss_grd])
mycol=c("green","yellow","red","blue","purple","orange","brown","black","pink","")
plot(scores, pch=19, col=mycol[pine.lead[,bgc_ss_grd]])


dat <- na.omit(pine.lead[,.(bgc_ss_grd,lead_si1,lead_si3,lead_si4,bh_stand_age,stemsha_LIV,aspect, slope)])
dat1 <- dat[,.(lead_si1,lead_si3,lead_si4,bh_stand_age,stemsha_LIV,aspect, slope)]
dist.pine.lead <- bcdist(dat1)
out1 <- metaMDS(dist.pine.lead, k=2, trymax=500)
plot(out1$points, pch=19)
mycol = c("green","red","blue","purple","black")
plot(out1$points, pch=19, col=mycol[sort(unique(dat[,bgc_ss_grd]))])
vectors <- vf(out1$points, dat ,nperm=10)
plot(vectors, col="red")
mygroups <- sort(unique(dat[,bgc_ss_grd]))
for (i in 1:6){
 ordiellipse(out1$points, dat[,bgc_ss_grd], conf=0.6, col=mycol[i], show.groups=mygroups[i])
}

boxplot(dat$stemsha_LIV~dat$bgc_ss_grd)
boxplot(dat$lead_si1~dat$bgc_ss_grd)

#density doesn't seem to relate to age, SI, or SS for pine leading
plot(dat$stemsha_LIV~dat$lead_si1, pch=19)
plot(dat$stemsha_LIV~dat$bh_stand_age, pch=19)
plot(dat$stemsha_LIV~dat$bgc_ss_grd, pch=19)

analysis.samples[,lead_si1 := ifelse(lead_si1==-99,NA,lead_si1)]
analysis.samples[,bgc_ss_grd := ifelse(is.na(bgc_ss_grd),0,bgc_ss_grd)]
analysis.samples[,.(SAMP_ID,tsa,spc_live1,bgc_ss_grd,lead_si1,lead_si3,lead_si4,bh_stand_age,stemsha_LIV,aspect, slope)]#[order(lead_si1)]

plot(analysis.samples$stemsha_LIV~analysis.samples$lead_si1, pch=19)
plot(analysis.samples$stemsha_LIV~analysis.samples$bh_stand_age, pch=19)
plot(analysis.samples$stemsha_LIV~analysis.samples$bgc_ss_grd, pch=19)

```


#this is getting ahead of myself - looking at diameters in 02 plot. But what I was looking for is what trees count in these plots. Not looking like regen would be tallied? Unless X = ingrowth


3. How old is the plot?
4. What size classes of trees were measured?
5. Is it a fixed area or variable area plot?
6. MPB?

```{r}

dat.list[[2]][,samp_plotID := paste0(samp_id,"_",plot_no)]

tree.dat <- dat.list[[2]]
unique(tree.dat[samp_id=="CMI5_0232_NFI",])

hist(tree.dat[samp_id== "CMI5_0232_NFI",dbh])


samples.dt[CMI5_0232_NFI,]

```


Selecting 2 of the best '02' plots
```{r}
samples.dt <- (dat.list[[1]])
#only one row per sample ID
uni.samples.dt<-unique(samples.dt, by="SAMP_ID")
criteria.samples <- uni.samples.dt[beclabel=="SBSmc2" & bgc_ss_grd>0]
table(criteria.samples$bgc_ss_grd)
remeas.samples <- criteria.samples[(criteria.samples[,meas_yr_first]!=criteria.samples[,meas_yr_last])]
table(remeas.samples$bgc_ss_grd)
analysis.samples <- remeas.samples[treatment != "THINNED" & stnd_org!="P"] #72? plots if use site series calls
analysis.samples[which(analysis.samples[,bgc_ss_grd==2]),.(SAMP_ID,tsa)]


#all rows
all.samps.dt <- samples.dt[beclabel=="SBSmc2" & bgc_ss_grd>0 & meas_yr_first != meas_yr_last & treatment != "THINNED"] 
all.samps.dt[,area_pm == area_ps]
all.samps.dt[which(all.samps.dt[,bgc_ss_grd==2]),.(SAMP_ID,tsa)]

#I need a 9 ha plot generated from the diameter distribution


```

