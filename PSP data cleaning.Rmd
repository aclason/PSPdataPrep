---
title: "PSP data cleaning"
author: "A. Clason"
date: "September 16, 2019"
output: html_document
---
Libraries
```{r}
library(data.table)
```

Import data
```{r}
r.path <- "L:/PSP data/PSP csv/"

#Import sample and then tree data
dat.type <- c("Sample","Trees")
tsas <- c("03","12","14","20","24","26")
read.list <- list()
dat.list <- list()

for(i in 1:length(dat.type)){
  setwd(paste0(r.path,dat.type[i]))
  for(j in 1:length(tsas)){
      read.list[[j]]<- fread(paste0("TSA",tsas[j],".csv"))
  }
  dat.list[[i]] <- rbindlist(read.list)
}
#result is dat.list which contains [[1]]:Sample and [[2]]Trees 
```

SITE SERIES APPROACH:

Sample data

This step will involve understanding all the information on a plot that is available, and determining which plots will be useful for a given purpose. Once the plots are id'd then can select those plotIDs from the Trees dataset (element 2 in dat.list)
Minimum Criteria:
1. Is the plot in the SBSmc2?
2. Does it have a Site Series call?

```{r}
#take the sample data.table out of a list and save in data.table format
samples.dt <- (dat.list[[1]])
# Remove repeats (which I think represent sub-plots) - mI'm doing this sometimes, but not everytime
uni.samples.dt<-unique(samples.dt, by="SAMP_ID")

#create the list of criteria needed to determine whether a plot should be included. This assumes that coding is consistent i.e SBSmc2 is spelled the same across datasets.
criteria.samples <- uni.samples.dt[beclabel=="SBSmc2" & bgc_ss_grd>0]
table(criteria.samples$bgc_ss_grd)
```

Re-measurement criteria:

1. What plots have multiple measurements?
2. What is the greatest time span for these measurements?
```{r}
remeas.samples <- criteria.samples[(criteria.samples[,meas_yr_first]!=criteria.samples[,meas_yr_last])]
range(remeas.samples[,tot_period]) #indicates min. remeasurement is 10 years
table(remeas.samples$bgc_ss_grd)
```
There could be one analysis here that tries to grow specific plot situations: thinned, beetle-killed etc. But for now, proceed to find the most number of plots that conform

Analysis criteria:

1. Remove if thinned
2. Remove if the plot planted (only 2 and they were also thinned)
```{r}
analysis.samples <- remeas.samples[treatment != "THINNED" & stnd_org!="P"] #72? plots if use site series calls
```
```{r}
#it seems that there is only 1 plot for all plots I've cut down to if I use all plots and don't remove duplicates:
all.samps.dt <- samples.dt[beclabel=="SBSmc2" & bgc_ss_grd>0 & meas_yr_first != meas_yr_last & treatment != "THINNED"] 
all.samps.dt[,area_pm == area_ps]
range(all.samps.dt[, no_plots])
unique(all.samps.dt[, shp_pm]) #all circles
all.samps.dt[SAMP_ID=="CMI5_0232_NFI",area_pm] #just saw different calls on Site Series for this plot - 01 in 2001, 02 in 2017

all.samps.dt[which(all.samps.dt[,bgc_ss_grd==2]),.(SAMP_ID,tsa)]

analysis.samples[,no_plots]
analysis.samples[,area_ps]

samples.dt[SAMP_ID=="CMI5_0232_NFI",1:100]

analysis.samples[,area_pm]
remeas.samples[,no_plots]
remeas.samples[,no_meas]

remeas.samples[,dbhlimit_breakpt] #tag limit in main vs. subplots
remeas.samples[,dbhlimit_tag] #tag limit in sub-plots
remeas.samples[which(remeas.samples[,bgc_ss_grd==2]),SAMP_ID]
```


SITE INDEX APPROACH:

Doing the same steps, but figuring out how many more or different plots meet the criteria if we include SI
```{r}
#looking at site index range from the plots that meet my criteria other then having site series:
samples.dt <- (dat.list[[1]])
uni.samples.dt<-unique(samples.dt, by="SAMP_ID")
criteria.samples <- uni.samples.dt[beclabel=="SBSmc2"]
remeas.samples <- criteria.samples[(criteria.samples[,meas_yr_first]!=criteria.samples[,meas_yr_last])]
range(remeas.samples[,tot_period]) #indicates min. remeasurement is 5 years
remeas.samples <- remeas.samples[tot_period>=10] #now has to be 10 years minimum
analysis.samples <- remeas.samples[treatment != "THINNED" & stnd_org!="P" & spc_live1!=""]
analysis.samples[,spc_live1] #104 potential plots if use SI

#look at possible 02 sites:
dim(pine.lead <- analysis.samples[spc_live1=="PL"]) #65 stands pine leading
pine.lead[,.(lead_si1,lead_si3,lead_si4,lead_age_bh1)]
pine.lead[,lead_si1 := ifelse(lead_si1==-99,NA,lead_si1)]
pine.lead[,.(SAMP_ID,tsa,bgc_ss_grd,lead_si1,lead_si3,lead_si4,lead_age_bh1)][order(lead_si1)]

# So lead_si4 comes from a TEM/PEM/SIBEC map layer. It's tempting to maintain this as an option on the hierarchy of data quality. Seems like it's too coarse to pick out the least productive sites (02?)

hist(pine.lead[,lead_si1a])
hist(pine.lead[,lead_si3a])
hist(pine.lead[,lead_si4a])

#what if I look at all plots and not just pine leading?
analysis.samples[,.(SAMP_ID,tsa,bgc_ss_grd,spc_live1,lead_si1,lead_si3,lead_si4,lead_age_bh1)][order(lead_si1)]


```


#this is getting ahead of myself - looking at diameters in 02 plot. But what I was looking for is what trees count in these plots. Not looking like regen would be tallied? Unless X = ingrowth


3. How old is the plot?
4. What size classes of trees were measured?
5. Is it a fixed area or variable area plot?
6. MPB?

```{r}

dat.list[[2]][,samp_plotID := paste0(samp_id,"_",plot_no)]

tree.dat <- dat.list[[2]]
unique(tree.dat[samp_id=="CMI5_0232_NFI",])

hist(tree.dat[samp_id== "CMI5_0232_NFI",dbh])


samples.dt[CMI5_0232_NFI,]

```

Aaron Trowbridge's PSP data:
```{r}
library(foreign)
library(data.table)
setwd("C:/Users/Alana2012/Sync/BVRC/SORTIE position/Data/PSP/raw PSP atrowbridge")

#ct0 <- read.dbf("aaron trowbrigdge sbs bwbs ich sbpspsps - ct0.dbf")
#ct0 <- as.data.table(ct0)

#ct0SBS <- ct0[ECOSYS == "SBS mc 2"]
#ct0SBS02 <- ct0[ECOSYS == "SBS mc 2 02"]
#ct0SBS03 <- ct0[ECOSYS == "SBS mc 2 03"]
#ct0SBS06 <- ct0[ECOSYS == "SBS mc 2 06"]
#ct0SBS05 <- ct0[ECOSYS == "SBS mc 2 05"]

#this would work if the ECOSYS call was consistent...but it's not!! Going to have to seperate the ecosystem pieces in excel?
#ct0Split <- ct0[, c("Zone", "Subzone", "Variant", "SiteSeries","a") := tstrsplit(ECOSYS, " ", fixed=TRUE)]
#as.data.table(ct0Split)

ct0 <- fread("aaron trowbrigdge sbs bwbs ich sbpspsps - ct0_BECsplit.csv", stringsAsFactors = TRUE)
    ct0ss <- ct0[SiteSeries != ""]
    length(ct0ss$SiteSeries)
    table(ct0ss$SiteSeries)
    plot(ct0ss$SiteSeries)
    #of the 4399 measurements with site series called for all zones, 2011 are 01, 71 are 02
    
    ct0ss02 <- ct0ss[SiteSeries==2]
    table(ct0ss02$Zone)
    #of the 71 02 measurements, 10 in the BWBS, 33 in the ICH, 4 in the SBPS, 24 SBS
    unique(ct0ss02$SAMP_ID)
    #71 measurements are in 28 plots
    
    ct0SBS_02 <- ct0ss02[Zone=="SBS"]
    table(ct0SBS_02$Subzone)
    #the 24 02 sites in the SBS are in the mc, mk, wk only. Combine with the SBPS?
    unique(ct0SBS_02$SAMP_ID)
    #24 measurements in 10 plots
    
    ct0SBS_SBPS_02 <- ct0ss02[Zone %in% c("SBS","SBPS")]
    #all plots were active in 2006
    unique(ct0SBS_SBPS_02$SAMP_ID)
    #this gets the tally up to 14 plots
    
    #create the csv to get climate data from climateWNA:
    ctUTMs <- read.dbf("aaron trowbrigdge sbs bwbs ich sbpspsps - utms.dbf")
    ctUTMs <- as.data.table(ctUTMs)
    
    #Merge with UTMS
    #samp_id, utmz, utme, utmn from ctUTMs
    #SAMP_ID, ELEV from ct0
    ctUTMs <- setnames(ctUTMs,"samp_id","SAMP_ID")
    ct0_utm <- merge(ct0,ctUTMs, by="SAMP_ID")
    
    ct0_Clim <- unique(ct0_utm, by="SAMP_ID")
    ct0_ClimWNA  <- ct0_Clim[,.(SAMP_ID,SiteSeries,ELEV,utmz,utme,utmn)]
    #write.csv(ct0_ClimWNA,"ct0_ClimWNA.csv")
      
    ct0_withClim <- fread("PSP_FROMClimWNA.csv", stringsAsFactors = TRUE)
    str(ct0_withClim)
    plot(ct0_withClim[,MAP]~ct0_withClim[,SiteSeries])
    plot(ct0_withClim[,MAP]~ct0_withClim[,MAT])

legend <- fread("Legend.csv")
ct1 <- fread("aaron trowbrigdge sbs bwbs ich sbpspsps - ct1.csv", stringsAsFactors = TRUE)
  str(ct1)
  ct1$MEAS_NO <- as.integer(ct1$MEAS_NO)
  ct0_1 <- merge(ct0,ct1, by=c("SAMP_ID","MEAS_NO"))
  ct0_1_utm <- merge(ct0_1,ct0_withClim, by="SAMP_ID")

ct2 <- fread("aaron trowbrigdge sbs bwbs ich sbpspsps - ct2.csv", stringsAsFactors = TRUE)
  str(ct2)
  ct0_1_2_utm <- merge(ct2,ct0_1_utm, by=c("SAMP_ID","MEAS_NO"))

ct3 <- fread("aaron trowbrigdge sbs bwbs ich sbpspsps - ct3.csv", stringsAsFactors = TRUE)
  str(ct3)
  ct0_1_2_3_utm <- merge(ct3,ct0_1_2_utm, by=c("SAMP_ID","MEAS_NO"))

ct4 <- fread("aaron trowbrigdge sbs bwbs ich sbpspsps - ct4.csv", stringsAsFactors = TRUE)
  str(ct4)
  ct0_1_2_3_4_utm <- merge(ct4,ct0_1_2_3_utm, by=c("SAMP_ID","MEAS_NO"))


ct5 <- fread("aaron trowbrigdge sbs bwbs ich sbpspsps - ct5.csv", stringsAsFactors = TRUE)
  str(ct5)


```

